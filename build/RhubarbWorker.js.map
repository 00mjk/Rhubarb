{"version":3,"file":"RhubarbWorker.js","sources":["../js/worker/WebSocketWorker.js"],"sourcesContent":["var WebSocketWorker = function(){\n  this.pingMsg = new Float32Array(1);\n  this.intermediateBuffers = new Object();\n  this.transferableList = [];\n}\n\nWebSocketWorker.prototype.sendPing = function(){\n  if (worker.isSocketClosed){\n    return;\n  }\n  worker.ws.send(worker.pingMsg.buffer);\n  worker.lastPingSendTime = performance.now();\n}\n\nWebSocketWorker.prototype.onWSOpen = function(){\n  worker.isSocketClosed = false;\n  postMessage({isConnected: true});\n  setTimeout(this.sendPing, 3000);\n}\n\nWebSocketWorker.prototype.onWSMessage = function(event){\n  worker.latency = performance.now() - worker.lastPingSendTime;\n  var view = new Float32Array(event.data);\n  var protocolID = view[0];\n  if (protocolID == 0){\n    setTimeout(worker.sendPing, 3000);\n  }\n}\n\nWebSocketWorker.prototype.onWSClose = function(){\n  worker.isSocketClosed = true;\n}\n\nWebSocketWorker.prototype.onWSError = function(event){\n  postMessage({isError: true});\n}\n\nWebSocketWorker.prototype.connect = function(serverURL){\n  var ws = new WebSocket(serverURL);\n  ws.onopen = this.onWSOpen.bind(this);\n  ws.onmessage = this.onWSMessage.bind(this);\n  ws.onclose = this.onWSClose.bind(this);\n  ws.onerror = this.onWSError.bind(this);\n  ws.binaryType = \"arraybuffer\";\n  this.ws = ws;\n}\n\nvar worker = new WebSocketWorker();\n\nself.onmessage = function(message){\n  var data = message.data;\n\n  if (data.serverURL){\n    worker.connect(data.serverURL);\n  }else{\n    var length = data.array.length;\n    var intermediateBuffer = worker.intermediateBuffers[length];\n    if (!intermediateBuffer){\n      intermediateBuffer = new Float32Array(length);\n      worker.intermediateBuffers[length] = intermediateBuffer;\n    }\n    for (var i = 0; i<data.array.length; i++){\n      intermediateBuffer[i] = data.array[i];\n    }\n    worker.transferableList[0] = data.array.buffer;\n    postMessage(data, worker.transferableList);\n    worker.ws.send(intermediateBuffer.buffer);\n  }\n}\n"],"names":["WebSocketWorker","pingMsg","Float32Array","intermediateBuffers","Object","transferableList","prototype","sendPing","worker","isSocketClosed","ws","send","buffer","lastPingSendTime","performance","now","onWSOpen","isConnected","onWSMessage","event","latency","view","data","protocolID","onWSClose","onWSError","isError","connect","serverURL","WebSocket","onopen","bind","onmessage","onclose","onerror","binaryType","self","message","length","array","intermediateBuffer","i"],"mappings":";;;;;;AAAA,IAAIA,kBAAkB,SAAlBA,eAAkB,GAAU;OACzBC,OAAL,GAAe,IAAIC,YAAJ,CAAiB,CAAjB,CAAf;OACKC,mBAAL,GAA2B,IAAIC,MAAJ,EAA3B;OACKC,gBAAL,GAAwB,EAAxB;CAHF;;AAMAL,gBAAgBM,SAAhB,CAA0BC,QAA1B,GAAqC,YAAU;MACzCC,OAAOC,cAAX,EAA0B;;;SAGnBC,EAAP,CAAUC,IAAV,CAAeH,OAAOP,OAAP,CAAeW,MAA9B;SACOC,gBAAP,GAA0BC,YAAYC,GAAZ,EAA1B;CALF;;AAQAf,gBAAgBM,SAAhB,CAA0BU,QAA1B,GAAqC,YAAU;SACtCP,cAAP,GAAwB,KAAxB;cACY,EAACQ,aAAa,IAAd,EAAZ;aACW,KAAKV,QAAhB,EAA0B,IAA1B;CAHF;;AAMAP,gBAAgBM,SAAhB,CAA0BY,WAA1B,GAAwC,UAASC,KAAT,EAAe;SAC9CC,OAAP,GAAiBN,YAAYC,GAAZ,KAAoBP,OAAOK,gBAA5C;MACIQ,OAAO,IAAInB,YAAJ,CAAiBiB,MAAMG,IAAvB,CAAX;MACIC,aAAaF,KAAK,CAAL,CAAjB;MACIE,cAAc,CAAlB,EAAoB;eACPf,OAAOD,QAAlB,EAA4B,IAA5B;;CALJ;;AASAP,gBAAgBM,SAAhB,CAA0BkB,SAA1B,GAAsC,YAAU;SACvCf,cAAP,GAAwB,IAAxB;CADF;;AAIAT,gBAAgBM,SAAhB,CAA0BmB,SAA1B,GAAsC,UAASN,KAAT,EAAe;cACvC,EAACO,SAAS,IAAV,EAAZ;CADF;;AAIA1B,gBAAgBM,SAAhB,CAA0BqB,OAA1B,GAAoC,UAASC,SAAT,EAAmB;MACjDlB,KAAK,IAAImB,SAAJ,CAAcD,SAAd,CAAT;KACGE,MAAH,GAAY,KAAKd,QAAL,CAAce,IAAd,CAAmB,IAAnB,CAAZ;KACGC,SAAH,GAAe,KAAKd,WAAL,CAAiBa,IAAjB,CAAsB,IAAtB,CAAf;KACGE,OAAH,GAAa,KAAKT,SAAL,CAAeO,IAAf,CAAoB,IAApB,CAAb;KACGG,OAAH,GAAa,KAAKT,SAAL,CAAeM,IAAf,CAAoB,IAApB,CAAb;KACGI,UAAH,GAAgB,aAAhB;OACKzB,EAAL,GAAUA,EAAV;CAPF;;AAUA,IAAIF,SAAS,IAAIR,eAAJ,EAAb;;AAEAoC,KAAKJ,SAAL,GAAiB,UAASK,OAAT,EAAiB;MAC5Bf,OAAOe,QAAQf,IAAnB;;MAEIA,KAAKM,SAAT,EAAmB;WACVD,OAAP,CAAeL,KAAKM,SAApB;GADF,MAEK;QACCU,SAAShB,KAAKiB,KAAL,CAAWD,MAAxB;QACIE,qBAAqBhC,OAAOL,mBAAP,CAA2BmC,MAA3B,CAAzB;QACI,CAACE,kBAAL,EAAwB;2BACD,IAAItC,YAAJ,CAAiBoC,MAAjB,CAArB;aACOnC,mBAAP,CAA2BmC,MAA3B,IAAqCE,kBAArC;;SAEG,IAAIC,IAAI,CAAb,EAAgBA,IAAEnB,KAAKiB,KAAL,CAAWD,MAA7B,EAAqCG,GAArC,EAAyC;yBACpBA,CAAnB,IAAwBnB,KAAKiB,KAAL,CAAWE,CAAX,CAAxB;;WAEKpC,gBAAP,CAAwB,CAAxB,IAA6BiB,KAAKiB,KAAL,CAAW3B,MAAxC;gBACYU,IAAZ,EAAkBd,OAAOH,gBAAzB;WACOK,EAAP,CAAUC,IAAV,CAAe6B,mBAAmB5B,MAAlC;;CAjBJ;;;;"}